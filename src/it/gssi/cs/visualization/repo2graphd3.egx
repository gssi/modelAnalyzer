import "helper.eol";
pre{
var emfTool = new Native("org.eclipse.epsilon.emc.emf.tools.EmfTool");
}

rule Repo2Graphviz
    transform qe : QualityEcosystem::QualityEcosystemDef {

    template : "repo2graphd3.egl"
    

    parameters : Map{
        "path" = Sequence{"Repository"},
        "icon" = "diagram-ffffff",
        "format" = "html",
        "layers" = qe.getMapLayers(),
        "nodes" = qe.ecosystemModel.artifacts,
        "evals" = qe.evaluations,
        "edges" =qe.ecosystemModel.relations
    }
}

rule Metamodel
 
	transform qeval : QualityEcosystem::QualityEval{

	template : "selection2graphd3.egl"

	parameters : Map{
		"path" = Sequence{"Repository", qeval.subject.name},
		"icon" = "diagram-c0c0c0",
		"format" = "html",
		"layers" = Sequence {
			
			
		},
		"layers" = qeval.def.getMapLayers(),
        "nodes" =  qeval.getConnected(),
        "evals" =  qeval.def.evaluations,
        "edges" = qeval.def.ecosystemModel.relations.select(e|e.src==qeval.subject or e.trg==qeval.subject)
        
		
	}
	
}

rule Model
 
	transform n : MDEEcosystem::Model{

	template : "selection2graphd3.egl"

	parameters : Map{
		"path" = Sequence{"Repository", n.subject.name},
		"icon" = "diagram-c0c0c0",
		"format" = "html",
		"layers" = Sequence {
			
			
		},
		"layers" = qeval.def.getMapLayers(),
        "nodes" =  qeval.getConnected(),
        "evals" =  qeval.def.evaluations,
        "edges" = qeval.def.ecosystemModel.relations.select(e|e.src==qeval.subject or e.trg==qeval.subject)
        
		
	}
	
}

operation QualityEval getConnected(): Set(Artifact){
var ecosystem = self.def.ecosystemModel;
return ecosystem.artifacts.select(a|ecosystem.relations.select(rel| emfTool.EcoreUtil.equals(rel.src,a) or emfTool.EcoreUtil.equals(rel.trg,a)).select(r|emfTool.EcoreUtil.equals(r.src,self.subject) or emfTool.EcoreUtil.equals(r.trg,self.subject)).size()>0);
}

